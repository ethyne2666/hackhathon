{% extends "dbApp/base.html" %}
{% load static %}

{% block title %}Purchase Schedule{% endblock %}

{% block content %}
<div class="schedule-page">
    <div class="schedule-container">
        <div class="product-info-panel">
            <div class="product-card-container">
                <img src="{{ product.image.url }}" class="product-image" alt="{{ product.name }}">
                <h5 class="product-name">{{ product.name }}</h5>
                <p class="product-price">Unit Price: ₹{{ product.price }}</p>
            </div>
        </div>

        <div class="schedule-form-panel">
            <div class="schedule-form-container">
                <h2 class="form-title">Schedule Order</h2>

                <form method="post" id="scheduleForm">
                    {% csrf_token %}

                    <div class="form-group">
                        <label class="form-label">Delivery Frequency</label>
                        {{ form.frequency }}
                    </div>

                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        {{ form.start_date }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        {{ form.end_date }}
                    </div>

                    <hr class="summary-divider">

                    <h5 class="summary-title">Order Summary</h5>
                    <div class="summary-line">Unit Cost: ₹<span id="unitCost">{{ product.price }}</span></div>
                    <div class="summary-line">Number of Units: <span id="numUnits">0</span></div>
                    <div class="summary-line">Subtotal: ₹<span id="subtotal">0</span></div>
                    <div class="summary-line">Delivery Fee: ₹<span id="deliveryFee">30</span></div>
                    <div class="summary-line total-line">Total: ₹<span id="total">0</span></div>
                </form>

                <form id="checkoutForm" method="post" action="{% url 'payment' %}">
                    {% csrf_token %}
                    <input type="hidden" name="subtotal" id="checkoutSubtotal">
                    <input type="hidden" name="delivery_fee" value="30">
                    <button type="submit" class="btn-schedule-checkout">Proceed to Checkout</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function calculateUnits() {
        const startDate = new Date(document.getElementById("id_start_date").value);
        const endDate = new Date(document.getElementById("id_end_date").value);
        const frequency = document.getElementById("id_frequency").value;
        const unitCost = parseFloat(document.getElementById("unitCost").textContent);
        const deliveryFee = 30;

        if (!startDate || !endDate || endDate <= startDate) {
            document.getElementById("numUnits").textContent = 0;
            document.getElementById("subtotal").textContent = "0.00";
            document.getElementById("total").textContent = "0.00";
            return;
        }

        let diffDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        let units = 0;

        switch(frequency) {
            case "daily": units = diffDays; break;
            case "weekly": units = Math.ceil(diffDays / 7); break;
            case "every_10_days": units = Math.ceil(diffDays / 10); break;
            case "every_15_days": units = Math.ceil(diffDays / 15); break;
            case "monthly": units = Math.ceil(diffDays / 30); break;
            case "every_3_months": units = Math.ceil(diffDays / 90); break;
        }

        const subtotal = units * unitCost;
        const total = subtotal + deliveryFee;

        document.getElementById("numUnits").textContent = units;
        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("total").textContent = total.toFixed(2);
        document.getElementById("checkoutSubtotal").value = subtotal.toFixed(2);
    }

    document.getElementById("id_start_date").addEventListener("change", calculateUnits);
    document.getElementById("id_end_date").addEventListener("change", calculateUnits);
    document.getElementById("id_frequency").addEventListener("change", calculateUnits);

    calculateUnits(); // Initial calculation on page load
</script>
{% endblock %}